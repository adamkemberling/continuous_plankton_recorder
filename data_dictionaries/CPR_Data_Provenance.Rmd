---
title: "CPR Data Provenance"
description: |
  Starting points and data transformations (in english) for CPR analyses.
author:
  - name: Adamkemberling 
    url: github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
    affiliation_url: gmri.org
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, comment = "", warning = FALSE)
library(tidyverse)
library(gt)
library(gmRi)
library(targets)
library(patchwork)
library(tidyverse)
library(sf)

# Polygons for mapping
new_england <- rnaturalearth::ne_states("united states of america") %>% st_as_sf(crs = 4326)
canada <- rnaturalearth::ne_states("canada") %>% st_as_sf(crs = 4326)
```

`r gmRi::use_gmri_style_rmd()`

# CPR Data Provenance

The data for the [continuous plankton recorder survey (CPR)](<https://www.cprsurvey.org/services/the-continuous-plankton-recorder/>) has been collected and maintained by multiple government and non-government organizations.

The methods for data collection and sampling processes have remained consistent, however the data processing/storage has revealed some differences across research entities.

This documentation seeks to document the different data available to us here, and the data contained within each starting point. Once the starting points are clear, the data processing steps will be detailed to provide clarity on how these different resources can be used together.

All final processing code has been moved to the {targets} pipeline, with all processing steps written as functions in:\
\> **R/support/gom_cpr_pipeline_support.R**

# CPR Data: Starting Points:

There are two transects of the CPR survey that we have access to the data for. The Gulf of Maine and the Mid-Atlantic transects.

## Gulf of Maine Transect

Data for the Gulf of Maine transect was transferred to us from two sources. [The Sir Alister Hardy Foundation](<https://www.cprsurvey.org/about-us/sir-alister-hardy-and-the-continuous-plankton-recorder-cpr-survey/>), and the Northeast Fisheries Science Center. This transect crosses the Gulf of Maine traveling originally to Boston, but transitioning to Portland more recently.

```{r, fig.height = 3}

withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(gom_combined_zooplankton))   

# clean up dates
gom_abund <- gom_combined_zooplankton %>% 
  mutate(
    month = str_pad(month, width = 2, side = "left", pad = "0"),
    day = str_pad(day, width = 2, side = "left", pad = "0"),
    date = as.Date(str_c(year, month, day, sep = "-")),
    .after = station,
    day = NULL,
    month = NULL,
    `longitude (degrees)` = ifelse(
      `longitude (degrees)` > 0,
      `longitude (degrees)` * -1,
      `longitude (degrees)`))


##### Map GOM  ####

# Make a box around points
gom_extent <- structure(
  c(
    xmin = min(gom_abund$`longitude (degrees)`),
    ymin = min(gom_abund$`latitude (degrees)`),
    xmax = max(gom_abund$`longitude (degrees)`),
    ymax = max(gom_abund$`latitude (degrees)`)),
  class = "bbox",
  crs = 4326
) %>% st_as_sfc()


# sf for GOM points
gom_sf <- gom_abund %>% 
  distinct(date, station, `longitude (degrees)`, `latitude (degrees)`) %>% 
  st_as_sf(coords = c("longitude (degrees)", "latitude (degrees)"), 
           crs = 4326, remove = FALSE)


# Map for GOM region
gom_map <- ggplot() +
  geom_sf(data = new_england, size = 0.3) +
  geom_sf(data = canada, size = 0.3) +
  geom_sf(data = gom_sf, shape = 3, alpha = 0.2) +
  coord_sf(xlim = c(-73, -63),
           ylim = c(41.75, 45),
           expand = T) +
  theme_bw() +
  labs(subtitle = "CPR Survey: Gulf of Maine Transect")
gom_map
```

### Individual Taxon Files:

#### **Root File Location**

CPR data on individual taxon were delivered through email and stored in the following directory on box.

> **Box/Adam Kemberling/Box_Projects/continuous_plankton_recorder/**

All derived data from these starting files are under this directory. This is not a permanent home, but is the location the `cpr_boxpath` refers to in the code:

When initially engaging with the CPR data, requests for CPR data on specific taxa were requested and received as individual files. These came in two groups that contain both annual averages and some within-year averages (bi-monthly or quarterly).

```{r}

# Quarterly: 00_cprdata_first_look.R
annual_taxa <- tribble(
  ~"File Name",                         ~"Description",
  #|                                    |
  "Calanus_finmarchicus.txt",      "Late stage C. Finmarchicus densities",
  "Calanus_I-IV.txt",              "Early-stage C. finmarchicus densities",
  "Centropages_typicus.txt",       "Centropages typicus densities",
  "Chaetognatha_eyecount.txt",     "Chaetognatha spp. densities",
  "Euphausiacea_Total.txt",        "Euphausiacea densities",
  "Metridia_lucens.txt",           "Metridia lucens densities",
  "Oithona_spp..txt",              "Oithona spp. densities",
  "Para-Pseudocalanus_spp..txt",   "Paracalanus & Pseudocalanus densities",
  "Paraeuchaeta_norvegica.txt",    "Paraeuchaeta norvegica densities",
  "Temora_longicornis.txt",        "Temora longicornis densities"
) %>% 
  mutate(`Temporal Frequency` = "Bi-monthly periods",
         Folder = "CPRtimeseries_textX6")




# Quarterly: 00b_cprdata_first_look.R
quarterly_taxa <- tribble(
  ~"File Name",                         ~"Description",
  #|                                    |
  "GOMx.Calanus_finmarchicus.txt",      "Late stage C. Finmarchicus densities",
  "GOMx.Calanus_I-IV.txt",              "Early-stage C. finmarchicus densities",
  "GOMx.Centropages_typicus.txt",       "Centropages typicus densities",
  "GOMx.Chaetognatha_eyecount.txt",     "Chaetognatha spp. densities",
  "GOMx.Euphausiacea_Total.txt",        "Euphausiacea densities",
  "GOMx.Metridia_lucens.txt",           "Metridia lucens densities",
  "GOMx.Oithona_spp..txt",              "Oithona spp. densities",
  "GOMx.Para-Pseudocalanus_spp..txt",   "Paracalanus & Pseudocalanus densities",
  "GOMx.Paraeuchaeta_norvegica.txt",    "Paraeuchaeta norvegica densities",
  "GOMx.Temora_longicornis.txt",        "Temora longicornis densities"
) %>% 
  mutate(`Temporal Frequency` = "Quarterly periods",
         Folder = "CPRtimeseries_textX")

# Show table
bind_rows(annual_taxa, quarterly_taxa) %>% 
  select(Folder, `File Name`, Description, `Temporal Frequency`) %>% 
  arrange(Folder, `File Name`) %>% 
  gt::gt()
```

These collections are each processed into two additional files, one for the yearly densities and the second for quarterly densities. These two intermediate/processed files are:

```{r}
tribble(
  ~"Folder",        ~"File Name",                       ~"Description", 
  #                 |                                   |        ,
  "processed_data", "cpr_allspecies_long.csv",          "reshaping of bi-monthly single species taxa",
  "processed_data", "cpr_allspecies_long_quarters.csv", "reshaping of quarterly single species taxa"
) %>% gt()
```

# Starting Points: All Taxa Files

For questions relating to the full zooplankton community we also requested and received data on all taxa collected as part of the CPR survey as well as the phytoplankton color index (PCI). These were sourced from the two different management entities, NEFSC and SAHFOS, which were responsible for data collection and management for different periods of time.

These files were placed within the Climate Change Ecology Lab directory on Box, referenced as `ccel_boxpath` in the code:

> **Box/Climate Change Ecology Lab**

The discrete steps in the CPR data processing pipeline for these files are detailed using the {targets} package. The following diagram details the data at each step in the pipeline from the three individual files to the combined zooplankton dataset.

<!--- Adding a border around html output --->

```{=html}
<!--
<style>
    canvas {
        border: groove;
    }
</style>
--->
```
```{r, message=FALSE,}

withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_glimpse())   
```

## NOAA/NEFSC Starting Points

Data obtained from NOAA/NEFSC spans the period of: **1961-2013**, and was delivered in the following excel file:

> **Data/NOAA_1961-2013/Gulf of Maine CPR (Feb 14, 2014 update).xlsx**

That excel file is divided into **2** sheets. One contains data on phytoplankton and the other contains records on zooplankton.

Each excel sheet has two or more additional rows in the header explaining the identification and development stage of certain taxa. In the R script `13_allspecies_cpr_cleanup.R` these headers are stripped, and the different taxa and their stages are appended as the new column names.

Taxonomic codes are also checked against MARMAP codes to ensure accuracy <https://www.nefsc.noaa.gov/nefsc/Narragansett/taxcodesA.html>

Through email correspondence it was communicated that the units were abundance / 100 meters cubed.

```{r}
tribble(
  ~"Sheet Number",  ~"Description",  ~"Units",
  #                  |               |        
  
  "Sheet 1",  
  "Phytoplankton taxa densities by silk transect",
  "# / 100m3",
  
  "Sheet 2", 
  "Zooplankton taxa densities by silk transect",
  "# / 100m3"
) %>% gt()
```

### NOAA Abundances and Taxa Keys

At the end of the reshaping of these NOAA excel sheets, we are left with 4 different tables:

> gom_noaa_zoo\
> gom_noaa_phyto\
> gom_noaa_zoo_key\
> gom_noaa_phyto_key

The "keys" detail the taxonomic codes in the header, and their associated MARMAP codes. The other targets detail the abundances in a wide form, with columns displaying the abundance for each stage at each CPR station.

## SAHFOS Starting Points

Data obtained from SAHFOS spans the period of: **2013-2017**, and was delivered in the following files:

> **Gulf of Maine CPR/SAHFOS-MBA_2013-2017/MC part1.xlsx**\
> **Gulf of Maine CPR/SAHFOS-MBA_2013-2017/MC part 2.xlsx**

Each of these files contain **three** sheets containing the different counting scales of the CPR survey, the phytoplankton, the traverse, and the "eye-count" scales. These three scales are based on the size of organisms counted. At each scale different subsets of the silk transect are used when counting the individually identified taxa. Counts from the subsets are then scaled to the entire silk transect and given a number on a categorical counting scale. These represent discrete jumps in abundance per transect.

These three measurement increments correspond with the following sub-sampling protocols to save time when counting very small organisms:

1.  **Phyto** - 1/8000th of transect counted\
2.  **Traverse** - 1/40th of transect counted\
3.  **Eyecount** - full transect counted

```{r}
tribble(
 ~"Sheet Number",  ~"Description",  ~"Units",
  #                  |               |        
  
  "Sheet 1",  
  "Phytoplankton taxa densities by silk transect",
  "# / Transect",
  
  "Sheet 2", 
  "Zooplankton taxa densities by silk transect",
  "# / Transect",
 
  "Sheet 3", 
  "Eyecount taxa densities by silk transect",
  "# / Transect"
) %>% gt()
```

### SAHFOS Taxa Keys

The import and reshaping of this data is facilitated by taxon keys, which exist in the targets pipeline as the following targets and are created using information in the headers of the excel sheets:

> sahfos_mc1_taxa\
> sahfos_mc2_taxa

The SAHFOS keys are "long datasets" with only four columns. A column that details the measurement level (phyto, traverse, eye), a column detailing what taxon it is, the marmap number associated with it, and any notes from the header.

### SAHFOS Abundances

Because the SAHFOS data came as different sheets for different observation scales, we processed the data accordingly. Each measurement scale was processed in parallel for the MC1 & MC2 datasets before appending them together. This produced three sets of abundance data, one for phyto, traverse, and for eye count abundances. These were tagged as the following targets:

> sahfos_phyto
>
> sahfos_trav
>
> sahfos_eye

### Resolving Unit Differences

For the SAHFOS data, it was determined that the abundances recorded are in the abundance/transect and not abundance/100$m^3$ as recorded in the NOAA data.

These values are converted in this step to the **common unit of the zooplankton density as:** *Abundance per 100 cubic meters of water*.

To convert from the volume of water covered by a silk transect, the following constants are used:

```{r}
tribble(
  ~"Constant", ~"Value",
  "Distance Traveled by CPR Device for Transect", "10 Nautical Miles",
  "CPR Opening Aperture Size", "1.27 square cm",
  "CPR Aperture Size (square meters)", "0.0016129",
  "Meters in 10 Nautical Miles", "18520",
  "Volume Sampled in 10 Nautical Mile Transect", "2.987091 cubic meters",
  "Transect to 100m3 Equation", "(1 / 2.987091) * 100"
) %>%  gt()
```

Once abundances were in a common unit, zooplankton at the traverse and eye count scales were combined for a common zooplankton abundance dataset.

> sahfos_zoo_100m

### Resolving Taxon Group differences

The steps needed to unite the NOAA starting points and their counterparts among the SAHFOS starting points involves finding parsimony among the different column names that are a combination of **Taxa** and their **Development Stages**.

Across the two sources different groupings have been used that sometimes overlap and include some or all of another group. Example: Calanus 1-3 & Calanus 1-4 or Calanus 4-6...

Before these tables can be appended together these groupings need to be sorted out. This is done using the following two scripts which were later written as independent function steps for the targets pipeline:

> **15_NOAA_CPR_Cleanup.R**\
> **16_SAHFOS_CPR_Cleanup.R**

The resulting targets are:

> sahfos_zoo_renamed
>
> noaa_taxa_resolved

## Appending Data Sources

Once data from these two sources have been converted to common units of measurement and common taxonomic groupings they are able to be appended for one consistent timeseries.

> gom_combined_zooplankton

------------------------------------------------------------------------

# Mid-Atlantic Transect

The Mid-Atlantic transect is currently not processed to the extent of the Gulf of Maine data.
